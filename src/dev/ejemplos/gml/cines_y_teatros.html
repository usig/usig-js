<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>USIG - Mapa Interactivo de Buenos Aires</title>
    <link rel="stylesheet" type="text/css" href="../css/ejemplos.css" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
	<!-- DEV --><script src="../../usig.core.js" type="text/javascript"></script>
	<!-- DEV --><script src="../../usig.util.js" type="text/javascript"></script>
	<!-- DEV --><script src="../../usig.MapaInteractivo.js" type="text/javascript"></script>
	<!-- RELEASE <script src="../../usig.MapaInteractivo.min.js" type="text/javascript"></script> -->
    
	<script type="text/javascript">
	// Acá irían las mediciones obtenidas de la base de datos indexadas por TMI y 
	// con los datos reales que se vayan a querer mostrar
	datos_sensores = {1308: {decibeles: 22 } };
	
	$.noConflict();
	jQuery(document).ready(function($) {
		
		$('#mapa').css('width', 600).css('height', 450);
          
		mapa = new usig.MapaInteractivo('mapa', {
			includeToolbar: true,
			includePanZoomBar: true,
			onReady: function() {
				var smCines = new OpenLayers.Style({
					fillColor: '#99f',
					strokeColor: "blue", 
					strokeOpacity: "0.7", 
					strokeWidth: 2, 
					cursor: "pointer"
				});
				smCines.addRules([
				                  new OpenLayers.Rule({
				                	minScaleDenominator: 80000,
				                	symbolizer: {
				                		pointRadius: 4
				                	}
				                  }),
				                  new OpenLayers.Rule({
				                  	elseFilter: true,
				                  	symbolizer: {
				                  		pointRadius: 7
				                  	}
				                  })				                  
				                  ]);
				var layerCines = new OpenLayers.Layer.GML("GML", "cines.gml", {
	            	 styleMap: new OpenLayers.StyleMap(smCines)
	            });
	            // mapa.api.addLayer(layerCines);
				var smTeatros = new OpenLayers.StyleMap({
					default: {
			            externalGraphic: 'images/sitios_culturales.png',
			            backgroundGraphic: 'images/fondos/cua_verde.png',
			            pointRadius: 10,
						cursor: "pointer"						
					},
					select: {
						pointRadius: 18			            
					}
				});
				var clases = {
					bibliotecas: {
						filter: new OpenLayers.Filter.Comparison({
                	      type: OpenLayers.Filter.Comparison.EQUAL_TO,
                	      property: "ActividadPrincipal",
                	      value: 'Biblioteca',
	                	}),
	                	symbolizer: {
	                		externalGraphic: 'images/dep_culturales.png',
				            backgroundGraphic: 'images/fondos/cua_violeta.png',
	                		pointRadius: 7
	                	}
					},
                	centros_culturales: {
                		filter: new OpenLayers.Filter.Comparison({
                	      type: OpenLayers.Filter.Comparison.EQUAL_TO,
                	      property: "ActividadPrincipal",
                	      value: 'Centro Cultural',
	                	}),
	                	symbolizer: {
	                		externalGraphic: 'images/cen_culturales.png',
				            backgroundGraphic: 'images/fondos/cua_azul.png',
	                		pointRadius: 7		                		
	                	}
                	}
				}
				var escalas = [
					{ 
						minScaleDenominator: 80000,
						symbolizer: {pointRadius: 7}
					},
					{
						minScaleDenominator: 20000,
						maxScaleDenominator: 80000,
						symbolizer: {pointRadius: 9}
					},
					{
						maxScaleDenominator: 20000,
						symbolizer: {pointRadius: 13}
					}
				];
				var rules = new Array();
				$.each(escalas, function(i, escala) {					
					$.each(clases, function(j, clase) {
						var s = $.extend({}, clase.symbolizer, escala.symbolizer);
						rules.push(new OpenLayers.Rule(
							$.extend({}, clase, escala, {symbolizer: s})
						));
					});
					rules.push(new OpenLayers.Rule($.extend({}, escala, {elseFilter: true})));
				});
				smTeatros.styles['default'].addRules(rules);
				/*
				smTeatros.styles['default'].addRules([
	                  new OpenLayers.Rule({
	                	minScaleDenominator:80000,
	                	filter: rules.bibliotecas.filter,
	                	symbolizer: rules.bibliotecas.symbolizer
	                  }),
	                  new OpenLayers.Rule({
	                	minScaleDenominator: 80000,
	                	filter: rules.centros_culturales.filter,
	                	symbolizer: rules.centros_culturales.symbolizer
	                  }),
	                  new OpenLayers.Rule({
	                	maxScaleDenominator: 80000,
	                	minScaleDenominator: 20000,
	                	filter: rules.bibliotecas.filter,
	                	symbolizer: OpenLayers.Util.applyDefaults({pointRadius: 9}, rules.bibliotecas.symbolizer)
	                  }),
	                  new OpenLayers.Rule({
	                	maxScaleDenominator: 80000,
	                	minScaleDenominator: 20000,
	                	filter: rules.centros_culturales.filter,
	                	symbolizer: OpenLayers.Util.applyDefaults({pointRadius: 9}, rules.centros_culturales.symbolizer)
	                  }),
	                  new OpenLayers.Rule({
	                	maxScaleDenominator: 20000,
	                	filter: rules.bibliotecas.filter,
	                	symbolizer: OpenLayers.Util.applyDefaults({pointRadius: 13}, rules.bibliotecas.symbolizer)
	                  }),
	                  new OpenLayers.Rule({
	                	maxScaleDenominator: 20000,
	                	filter: rules.centros_culturales.filter,
	                	symbolizer: OpenLayers.Util.applyDefaults({pointRadius: 13}, rules.centros_culturales.symbolizer)
	                  }),
	                  new OpenLayers.Rule({
	                	minScaleDenominator: 80000,
	                  	elseFilter: true,
	                  	symbolizer: {
	                  		pointRadius: 7
	                  	}
	                  }),				                  
	                  new OpenLayers.Rule({
	                	maxScaleDenominator: 80000,
	                	minScaleDenominator: 20000,
	                  	elseFilter: true,
	                  	symbolizer: {
	                  		pointRadius: 9
	                  	}
	                  }),				                  
	                  new OpenLayers.Rule({
	                	maxScaleDenominator: 20000,
	                  	elseFilter: true,
	                  	symbolizer: {
	                  		pointRadius: 13
	                  	}
	                  })				                  
                  ]);
				*/
				var layerTeatros = new OpenLayers.Layer.Vector('Teatros', {
	            	styleMap: smTeatros
	            });
				/*
				var layerTeatros = new OpenLayers.Layer.GML("GML", "artes_escenicas.xml", {
	            	 styleMap: new OpenLayers.StyleMap(smTeatros)
	            });
				*/
				mapa.api.addLayer(layerTeatros);

				$.ajax({
					url: "http://epok.buho-dev.usig.gcba.gov.ar/dependenciasculturales/buscar?sector=1",
					dataType: 'jsonp',
					success: function(data) {
						var gml = new OpenLayers.Format.GML();
						layerTeatros.addFeatures(gml.read(data));
//						mapa.api.addLayer(layerTeatros);
					},
					error: function(e) {
						usig.debug(e);
					}
				});

				var highlightControl = new OpenLayers.Control.SelectFeature(
		                [layerTeatros, layerCines],
		                {
							hover: true,
		                    highlightOnly: true
		                }
		            );
				var selectControl = new OpenLayers.Control.SelectFeature(
			                [layerTeatros, layerCines],
			                {
			                    clickout: true, toggle: false,
			                    multiple: false, hover: false,
			                    toggleKey: "ctrlKey", // ctrl key removes from selection
			                    multipleKey: "shiftKey" // shift key adds to selection
			                }
			            );
			            
	            mapa.api.addControl(highlightControl);
	            mapa.api.addControl(selectControl);
	            highlightControl.activate();
	            selectControl.activate();
	            
	            layerTeatros.events.on({
	                "featureselected": function(e) {
	                	var feature=e.feature;
	        			var popup = new OpenLayers.Popup.FramedCloud(
	        					e.feature.id,
	        					new OpenLayers.LonLat(e.feature.geometry.x, e.feature.geometry.y),
	        	                null, //new OpenLayers.Size(10, 10),
	        	                "<div class='popup'><h3>" + e.feature.attributes['Nombre'] +"</h3><p class='indicator'>Buscando información...</p></div>",
	        	                null,
	        					true,
	        					function() {
	        	                	selectControl.unselect(feature);
	        	                });
	        			
	        			e.feature.popup = popup;
	        			mapa.api.addPopup(popup, true);
	    				$.ajax({
	    					url: "http://epok.buho-dev.usig.gcba.gov.ar/dependenciasculturales/detalle/"+e.feature.attributes['Id']+"/",
	    					dataType: 'jsonp',
	    					success: function(data) {
	    						if (popup != null && data.id==feature.attributes['Id']) {
		    	        			$('div.popup p.indicator').remove();
		    	        			var content = '<ul style="list-style-type: none; margin: 5px 0; padding: 0;">';
		    	        			$.each(data.contenido, function(k, v) {
		    	        				content+='<li><b>'+v.nombre+'</b>: '+v.valor+'</li>';
		    	        			});
		    	        			content+='</ul>';
		    	        			$('div.popup').append(content);
		    	        			popup.updateSize();
	    						}
	    					},
	    					error: function(e) {
	    						usig.debug(e);
	    					}
	    				});
 	                    // usig.debug("selected feature "+e.feature.id+" on Vector Layer 1");
	                },
	                "featureunselected": function(e) {
	                    mapa.api.removePopup(e.feature.popup);
	                    e.feature.popup.destroy();
	                    e.feature.popup = null;	                	
	                    usig.debug("unselected feature "+e.feature.id+" on Vector Layer 1");
	                }
	            });
	            layerCines.events.on({
	                "featureselected": function(e) {
	                    usig.debug("selected feature "+e.feature.id+" on Vector Layer 2");
	                },
	                "featureunselected": function(e) {
	                    usig.debug("unselected feature "+e.feature.id+" on Vector Layer 2");
	                }
	            });	            
				/*
	            mapa.api.addLayer(new OpenLayers.Layer.GML("GML", "http://epok.buho-dev.usig.gcba.gov.ar/dependenciasculturales/buscar?actividades=7", {
	            	styleMap: new OpenLayers.StyleMap(smTeatros)
	            }));
				*/							
			}
		});

		
	});	
	</script>
  </head>
  <body>
    <div id="page">
      <div id="header">
        <div id="logo"><h1>Ejemplo: Mapa Interactivo con capas GML</h1>
        	<p>Este ejemplo muestra como cargar capas de puntos desde un archivo GML, asignarle iconos customizados a cada una e incluso como mostrar datos asociados en el popup.</p>
        </div>
      </div>
      <div id="mapa"></div>
      <div id="footer">
        <p>&copy; 2011 USIG - Unidad de Sistemas de Información Geográfica</p>
      </div>
    </div>
  </body>
</html>
