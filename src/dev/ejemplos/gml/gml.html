<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>USIG - Mapa Interactivo de Buenos Aires</title>
    <link rel="stylesheet" type="text/css" href="../css/ejemplos.css" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
	<script src="http://servicios.usig.buenosaires.gob.ar/usig-js/2.3/usig.MapaInteractivo.min.js" type="text/javascript"></script>
    
	<script type="text/javascript">
	// Acá irían las mediciones obtenidas de la base de datos indexadas por TMI y 
	// con los datos reales que se vayan a querer mostrar
	datos_sensores = {1308: {decibeles: 22 } };
	
	$.noConflict();
	jQuery(document).ready(function($) {
		
		$('#mapa').css('width', 600).css('height', 450);
          
		var mapa = new usig.MapaInteractivo('mapa', {
			includeToolbar: true,
			includePanZoomBar: true,
			onReady: function() {
				
				// Carga los datos del archivo gml
				
				OpenLayers.loadURL("tmi_sensores_de_ruido.gml", "", null, function parseData(req) {
					var g =  new OpenLayers.Format.GML();
					var features = g.read(req.responseText);
					var i = 0;
					for(var feat in features) {
						if (typeof(features[feat].geometry)!="undefined") {
							
							// Creación del marker con el ícono personalizado
							// Este ejemplo usa dos íconos distintos 
							if (i%2==0){
								var iconUrl = 'images/punto_ruido.png';
								var iconSize = new OpenLayers.Size(20, 22);
							} else {
								var iconUrl = 'images/punto_ruido_verde.png';
								var iconSize = new OpenLayers.Size(20, 22);
							}
							++i;
							
							// Fabrica el marker y lo coloca en las cordenadas
							var customMarker = new OpenLayers.Marker(new OpenLayers.LonLat(features[feat].geometry.x,features[feat].geometry.y),new OpenLayers.Icon(iconUrl, iconSize));
							
							// Genera el contenido del tooltip
							
							var contentHTML="";	
							// Se puede seleccionar el campo a mostrar
							contentHTML += "TMI: " + features[feat].attributes['TMI'];
							contentHTML += "<br />";
							contentHTML += "BARRIO: " + features[feat].attributes['BARRIO'];
							// y acá se combinan los datos 
							if (typeof(datos_sensores[features[feat].attributes['TMI']]) != "undefined"){
								contentHTML += "<br />";
								contentHTML += "Decibeles: " + datos_sensores[features[feat].attributes['TMI']].decibeles;
							}
							var markerId = mapa.addMarker(customMarker, false, contentHTML);
						}
		            }
				});
				
			}
		});

		
	});	
	</script>
  </head>
  <body>
    <div id="page">
      <div id="header">
        <div id="logo"><h1>Ejemplo: Mapa Interactivo con capa GML</h1>
        	<p>Este ejemplo muestra como cargar una capa de puntos desde un archivo GML, asignarle iconos customizados a cada punto e incluso como mostrar datos asociados en el popup y mezclarlos con datos que provengan de otras fuentes.</p>
        </div>
      </div>
      <div id="mapa"></div>
      <div id="footer">
        <p>&copy; 2011 USIG - Unidad de Sistemas de Información Geográfica</p>
      </div>
    </div>
  </body>
</html>
