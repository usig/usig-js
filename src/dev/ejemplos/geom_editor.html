<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
	<meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
<<<<<<< .working
    <title>USIG - Mapa Interactivo de Buenos Aires</title>
    <link rel="stylesheet" type="text/css" href="css/ejemplos.css" />
=======
    <title>USIG - Recorridos</title>
    <link rel="stylesheet" type="text/css" href="css/demos.css" />
    <style>
    	body {
    		width: 550px;
    	}
    	.ramales {
    		color: #007baf;
    		cursor: pointer;
    	}
    	.transport {
    		color: #007baf;
    	}
    	.detalle_recorrido {
    		display: none;
    		font-size: 90%;
    	}
    	.par {
    		background: #f5f5f5;
    	}
    	.tiempo {
			width: 50px; 
			text-align: center;
			color: #007baf;
			font-weight: bold;
    	}
    	#recorridos {
    		margin-top: 10px;
    	}
		
    </style>
>>>>>>> .merge-right.r4467
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
	<script src="http://servicios.usig.buenosaires.gob.ar/usig-js/2.1/usig.AutoCompleterFull.min.js" type="text/javascript"></script>
	<script src="http://servicios.usig.buenosaires.gob.ar/usig-js/2.1/usig.MapaInteractivo.min.js" type="text/javascript"></script>

<<<<<<< .working
    
	<script type="text/javascript">
	$(document).ready(function() {
		
		var ac = new usig.AutoCompleter('b', {
       		onReady: function() {
       			$('#b').val('').removeAttr('disabled').focus();	        			
       		},
       		afterGeoCoding: function(pt) {
    			if (pt instanceof usig.Punto) {
    				miMapa.goTo(pt, true);
    			}       			
       		}
       	});
=======
	
	getServiceIcon = function(type) {
		var src = '';
		if ( type == 0 ) src = 'recorrido_pie';
	    if ( type == 1 ) src = 'recorrido_subte';
	    if ( type == 2 ) src = 'recorrido_tren';
	    if ( type == 3 ) src = 'recorrido_colectivo';
	    //FIXME armar una array
	    
	    return '<img src="' + opts.icons[src] + '" width="20" height="20">';
	}
	
	function procesarResumen() {
		var desc=[];
		descripcionHtml="";
		$.each(resumen,function(i,action) { 
			if(action.type == 'Board') { 
				if (!action.any_trip && action.service_type!=1){
					if (action.trip_description != ""){	//mostrar las descripciones en el asterisco
						var ramales = 'Ramales: ' + action.trip_description.replace('$',', ');
						descripcionHtml += getServiceIcon(action.service_type) + ' ' + action.service + '  <span class="ramales" title="'+ramales+'">(*)</span>';
						desc.push(action.service+' ('+ramales+')');
					}else{ // mostrar cartel de que hay mas ramales en el asterisco
						descripcionHtml += getServiceIcon(action.service_type) + ' ' + action.service + ' <span class="ramales" title="'+opts.texts.hayRamales+'">(*)  </span>';
						desc.push(action.service+' ('+opts.texts.hayRamales+')');
					}
				} else {
					descripcionHtml += getServiceIcon(action.service_type) + ' ' + action.service + '  ';
					desc.push(action.service); 
				}
			}
		});
		descripcion=desc.join(', ');
	}
	
	// ATENCION: Esto solo funciona para transporte publico, habria que cambiarlo para el resto
	function procesarPlan() {
 		var current_action = null;
 		var walking = false;
 		var changes = 0;
 		var ramal = null; 		
 		
		for(i=0;i<plan.length;i++) {
>>>>>>> .merge-right.r4467
		
		$('#mainForm').bind("submit", function () {
			return false;
		});
		
		$('#mapa').css('width', 600).css('height', 450);
        
		miMapa = new usig.MapaInteractivo('mapa', {
			onReady: function() {
				var outputFormatter = new OpenLayers.Format.GeoJSON();
				
				function serialize(feature) {
					var str = outputFormatter.write(feature, false);
				    document.getElementById('output').value = str;
				};
				      
				var vlayer = new OpenLayers.Layer.Vector( "Editable" );
				miMapa.api.layers.vector = vlayer;
				miMapa.api.addControl(new OpenLayers.Control.EditingToolbar(vlayer));
				miMapa.api.addLayer(vlayer);
				var select = new OpenLayers.Control.SelectFeature(vlayer, {
					hover: true,
					onSelect: serialize
				});
				miMapa.api.addControl(select);
				select.activate();
				$('#clear').click(function() {
					miMapa.api.layers.vector.removeFeatures(miMapa.api.layers.vector.features);
					miMapa.api.layers.vector.destroyFeatures();
					document.getElementById('output').value = '';
				});
			},
			OpenLayersJS: 'http://servicios.usig.buenosaires.gov.ar/OpenLayers/2.9.1-5/full/OpenLayers.js'
		});

		
<<<<<<< .working
	});	
	</script>
  </head>
  <body>
    <div id="page">
      <div id="header">
        <div id="logo"><h1>Ejemplo: Editor de geometrías</h1>
        <p>Este ejemplo muestra como utilizar los controles edición de OpenLayers combinandolos con los controles estándares del Mapa Interactivo de Buenos Aires y el AutoCompleter para ayudar en el posicionamiento inicial.</p>
	    <p>Use las herramientas de la esquina superior derecha para dibujar puntos, líneas o polígonos. Al pasar el mouse por encima luego verá el código GeoJSON de los objetos en el cuadro de abajo.</p>
        <textarea id="output" style="width: 100%;"></textarea>
        </div>
      </div>
      <div id="main">
       <form id="mainForm" accept-charset="iso-8859-1">
       <br/>
      	<label for="b">Buscar</label>
     	<input type="text" size="40" name="b" id="b" title="Lugar a buscar" class="text"/>
     	<span id="ejemplo">ej.: Callao y Corrientes, Florida 550, Teatro San Martín, etc.</span>
	    <div id="mapa"></div>
	    <button id="clear">Limpiar</button>
       </form>
      </div>
      <div id="footer">
        <p>&copy; 2012 USIG - Unidad de Sistemas de Información Geográfica</p>
      </div>
    </div>
  </body>
</html>=======
	function loadData(datos) {		
		try {
			id=datos.id;
			tiempo=datos.tiempo;
			origen=datos.origen;
			destino=datos.destino;
			tipo=datos.type;
			resumen=datos.summary;
			procesarResumen();
		} catch(e) {
			usig.debug('usig.Recorrido: Error cargando datos.');
		}
	}
	
	function cargarPlan(data, callback) {
		plan = data.plan;
		procesarPlan();
		if (typeof(callback) == "function")
			callback(detalle, plan);		
	}
	
	/**
	 * Permite cargar datos de un recorrido obtenidos del servicio de recorridos de USIG
	 * @param {Object} datos Datos del recorrido
	 */
	this.load = function(datos) {
		loadData(datos);
	}
	
	/**
	 * Devuelve la descripcion corta del recorrido (el listado ordenado de los
	 * transportes incluidos). 
	 * @return {String} Descripcion corta del recorrido
	 */	
	this.toString = function() {
		return descripcion;
	}
	
	/**
	 * Devuelve la descripcion corta del recorrido (el listado ordenado de los
	 * transportes incluidos) en formato HTML listo para mostrar e incluyendo los 
	 * iconos correspondientes para los diferentes tipos de transportes. 
	 * @return {String} Descripcion corta del recorrido en formato HTML
	 */	
	this.toHtmlString = function() {
		return descripcionHtml;
	}
	
	/**
	 * Devuelve el tiempo estimado del recorrido
	 * @return {Float} Tiempo estimado del recorrido en minutos
	 */
	this.getTime = function() {
		return tiempo;
	}

	/**
	 * Permite obtener el trip_plan del recorrido
	 * @param {Function} success Una funcion que es llamada cuando se obtiene el detalle del recorrido. 
	 * Recibe de parametro un Array(String) con una lista de strings con la descripcion de cada uno de 
	 * los pasos del recorrido y un Object conteniendo el trip_plan obtenido del servidor
	 * @param {Function} error Una funcion que es llamada en caso de error al intentar cargar el detalle 
	 * del recorrido
	 * @returns {Object} trip_plan obtenido del servidor o undefined en caso de que aun no se encuentre cargado
	 */
	this.getPlan = function(success, error) {
		if (!plan) {
			usig.Recorridos.cargarPlanRecorrido(id, cargarPlan.createDelegate(this, [success], 1), error);
		} else {
			if (typeof(success) == "function")
				success(plan);
		}
		return plan;
	}
	
	/**
	 * Permite obtener la descripcion detallada de cada uno de los pasos que componen el recorrido
	 * @param {Function} success Una funcion que es llamada cuando se obtiene el detalle del recorrido. 
	 * Recibe de parametro un Array(String) con una lista de strings con la descripcion de cada uno de 
	 * los pasos del recorrido y un Object conteniendo el trip_plan obtenido del servidor
	 * @param {Function} error Una funcion que es llamada en caso de error al intentar cargar el detalle 
	 * del recorrido
	 */
	this.getDetalle = function(success, error) {
		if (!plan) {
			usig.Recorridos.cargarPlanRecorrido(id, cargarPlan.createDelegate(this, [success], 1), error);
		} else {
			if (typeof(success) == "function")
				success(detalle);
		}
	}
	
	/**
	 * Devuelve el id del recorrido
	 * @return {Integer} Id del recorrido
	 */
	this.getId = function() {
		return id;
	}
	
	this.getTemplate = function() {
		return opts.template;
	}
	
	/**
	 * Devuelve el color asociado a este recorrido en formato HTML
	 * @returns {String} Color en formato HTML hexadecimal
	 */
	this.getColor = function() {
		return opts.template.color;
	}
	
	/**
	 * Permite setear un color a este recorrido
	 * @param {String} color Color especificado en formato hexa HTML incluyendo el #, por ej.: '#4A5076'
	 */
	this.setColor = function(color) {
		opts.template.color = color;
	}
	
	if (data) loadData(data);
};

usig.Recorrido.defaults = {
	icons: {
		recorrido_pie: 'http://mapa.buenosaires.gob.ar/images/recorrido_pie20x20.png', 	
		recorrido_subte: 'http://mapa.buenosaires.gob.ar/images/recorrido_subte20x20.png', 	
		recorrido_tren: 'http://mapa.buenosaires.gob.ar/images/recorrido_tren20x20.png', 	
		recorrido_colectivo: 'http://mapa.buenosaires.gob.ar/images/recorrido_colectivo20x20.png' 	
	},
	template: new usig.TripTemplate(1,'#8F58C7'),
	texts: {
		hayRamales:'No todos los ramales conducen a destino'		
	}
}

}

>>>>>>> .merge-right.r4467
